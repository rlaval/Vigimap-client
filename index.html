<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Carte client Vigimap</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
html, body { height:100%; margin:0; font-family:Arial,sans-serif; }
#map { width:100%; height:100%; }

/* ===== POPUP ESTH√âTIQUE ===== */
.leaflet-popup-content { margin:10px; font-size:14px; line-height:1.45; }
.popup-box { min-width:260px; }
.popup-title { font-size:18px; font-weight:bold; text-align:center; }
.popup-location { text-align:center; font-size:13px; color:#7f8c8d; margin-bottom:8px; }
.popup-section { border-top:1px solid #e6e6e6; padding:6px 0; }
.popup-label { font-weight:bold; color:#2c3e50; }

.vigi-badge {
  display:inline-block;
  padding:5px 10px;
  border-radius:14px;
  font-size:13px;
  font-weight:bold;
  color:white;
  margin:4px auto;
}
.vigi-1 { background:#2ecc71; }
.vigi-2 { background:#f1c40f; color:#000; }
.vigi-3 { background:#e67e22; }
.vigi-4 { background:#e74c3c; }
.vigi-5 { background:#9b59b6; }

/* ===== LOGO ===== */
#logo-vigimap {
  position:absolute;
  top:14px;
  left:50px;
  z-index:1000;
}
#logo-vigimap img { height:180px; }

/* ===== L√âGENDE ===== */
#legend {
  position:absolute;
  bottom:20px;
  right:20px;
  background:white;
  padding:10px;
  border-radius:8px;
  box-shadow:0 3px 10px rgba(0,0,0,0.3);
  font-size:13px;
  z-index:1000;
}
#legend div { display:flex; align-items:center; gap:6px; margin-bottom:4px; }
.legend-color { width:16px; height:16px; border-radius:4px; }

/* ===== LOGIN ===== */
#loginOverlay {
  position:absolute;
  top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.5); display:flex;
  justify-content:center; align-items:center; z-index:2000;
}
#loginBox {
  background:white; padding:30px; border-radius:12px; box-shadow:0 4px 16px rgba(0,0,0,0.3);
  width:300px; display:flex; flex-direction:column; gap:12px;
}
#loginBox input { padding:8px; border-radius:6px; border:1px solid #ccc; width:100%; }
#loginBox button { padding:10px; border:none; border-radius:6px; background:#2c3e50; color:white; cursor:pointer; font-size:15px; }

/* ===== INFOS CLIENT ===== */
#clientInfo {
  position:absolute;
  bottom:10px;
  left:10px;
  background:white;
  padding:10px 14px;
  border-radius:8px;
  box-shadow:0 4px 12px rgba(0,0,0,0.2);
  font-family:Arial,sans-serif;
  font-size:14px;
  z-index:1000;
}

#modeToggle {
  position: absolute;
  top: 14px;
  right: 20px;
  z-index: 1000;
  background: white;
  border: none;
  border-radius: 6px;
  padding: 3px 20px;       /* bouton plus petit */
  box-shadow: 0 2px 5px rgba(0,0,0,0.25);
  cursor: pointer;
  font-weight: bold;
  display: flex;
  align-items: center;
  gap: 3px;               /* petit espace entre logo et texte */
  font-size: 12px;         /* texte plus petit */
}
#modeToggle.dark { 
  background:#2c3e50; 
  color:white; 
}
#modeToggle img { 
  width:14px; 
  height:14px; 
}  /* logo plus petit */

#modeToggle.dark { background:#2c3e50; color:white; }

</style>

</style>
</head>

<body>

<div id="map"></div>

<div id="logo-vigimap">
  <img src="https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/logo_initiale_marron-_gourmand_-l-gant_minimaliste__15_-removebg-preview-high.png?enable-io=true&width=532">
</div>

<div id="legend">
  <div><span class="legend-color" style="background:green;"></span> Aucuns ph√©nom√®nes pr√©vus</div>
  <div><span class="legend-color" style="background:yellow;"></span> Ph√©nom√®nes faibles / mod√©r√©s possibles</div>
  <div><span class="legend-color" style="background:orange;"></span> Ph√©nom√®nes forts possibles</div>
  <div><span class="legend-color" style="background:red;"></span> Ph√©nom√®nes violents possibles</div>
  <div><span class="legend-color" style="background:purple;"></span> Ph√©nom√®nes extr√™mes pr√©vus</div>
</div>

<!-- LOGIN -->
<div id="loginOverlay">
  <div id="loginBox">
    <h3>Connexion Client</h3>
    <input id="loginEmail" type="email" placeholder="Email">
    <input id="loginPassword" type="password" placeholder="Mot de passe">
    <button id="loginBtn">Se connecter</button>
  </div>
</div>

<!-- INFOS CLIENT -->
<div id="clientInfo">Chargement des informations...</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
// üîπ Firebase init
firebase.initializeApp({
  apiKey:"AIzaSyDqb1u1HSfjmE-lE4ml9NrwGbAKCjf1D5o",
  authDomain:"vigimap-966e9.firebaseapp.com",
  projectId:"vigimap-966e9"
});
const db = firebase.firestore();
const auth = firebase.auth();

// üîπ Carte
const map = L.map("map").setView([44.35,2.57],10);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

// üîπ Tile layers clair / sombre
const lightLayer = L.tileLayer("https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png");
const darkLayer = L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png");

// Layer par d√©faut
lightLayer.addTo(map);
let currentLayer = "light";

// üîπ Bouton pour changer de mode avec logo
const modeBtn = L.control({position: 'topright'});
modeBtn.onAdd = function() {
  const btn = L.DomUtil.create('button','');
  btn.id = "modeToggle";

  // Logo
  const img = document.createElement("img");
  img.src = "https://cdn-icons-png.flaticon.com/512/0/370.png";
  btn.appendChild(img);

  // Texte initial
  const span = document.createElement("span");
  span.textContent = "Carte claire";  // texte initial
  btn.appendChild(span);

  btn.onclick = ()=>{
    const text = btn.querySelector("span");
    if(currentLayer==="light"){
      map.removeLayer(lightLayer);
      darkLayer.addTo(map);
      text.textContent = "Carte normale";  // texte quand mode gris activ√©
      btn.classList.add("dark");
      currentLayer="dark";
    } else {
      map.removeLayer(darkLayer);
      lightLayer.addTo(map);
      text.textContent = "Carte claire";   // texte quand mode clair activ√©
      btn.classList.remove("dark");
      currentLayer="light";
    }
  };
  return btn;
};
modeBtn.addTo(map);

// üîπ Style pour les contours des d√©partements
const deptStyle = {
  color: "#2c3e50",
  weight: 1,
  fillColor: "#2c3e50",
  fillOpacity: 0.05
};

// üîπ URL du GeoJSON simplifi√© des d√©partements
const deptGeojsonUrl =
  "https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/departements-version-simplifiee.geojson";

// üîπ Charger le GeoJSON et filtrer
fetch(deptGeojsonUrl)
  .then(response => response.json())
  .then(data => {
    // Codes INSEE des d√©partements cibl√©s
    const codesVoulu = ["46", "19", "15", "48", "12", "81", "82"];

    const filtered = {
      type: "FeatureCollection",
      features: data.features.filter(
        f => f.properties.code && codesVoulu.includes(f.properties.code)
      )
    };

    // Ajouter les contours filtr√©s √† la carte
    L.geoJSON(filtered, {
      style: deptStyle
    }).addTo(map);

  })
  .catch(err =>
    console.error("Erreur chargement GeoJSON d√©partements:", err)
  );






// üîπ Ic√¥nes et labels
const baseIcon = { iconSize:[36,36], iconAnchor:[18,18], popupAnchor:[0,-22] };
const icons = {
  1:L.icon({...baseIcon, iconUrl:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/logo_initiale_marron-_gourmand_-l-gant_minimaliste__10_-removebg-preview-high.png?enable-io=true&width=532"}), 
  2:L.icon({...baseIcon, iconUrl:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/logo_initiale_marron-_gourmand_-l-gant_minimaliste__11_-removebg-preview-high.png?enable-io=true&width=532"}), 
  3:L.icon({...baseIcon, iconUrl:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/logo_initiale_marron-_gourmand_-l-gant_minimaliste__12_-removebg-preview-high.png?enable-io=true&width=532"}), 
  4:L.icon({...baseIcon, iconUrl:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/logo_initiale_marron-_gourmand_-l-gant_minimaliste__13_-removebg-preview-high.png?enable-io=true&width=532"}), 
  5:L.icon({...baseIcon, iconUrl:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/logo_initiale_marron-_gourmand_-l-gant_minimaliste__14_-removebg-preview-high.png?enable-io=true&width=532"})
};
const vigilanceText = {1:"Aucuns ph√©nom√®nes pr√©vus",2:"Ph√©nom√®nes faibles / mod√©r√©s possibles",3:"Ph√©nom√®nes forts possibles",4:"Ph√©nom√®nes violents possibles",5:"Ph√©nom√®nes extr√™mes pr√©vus"};
const phenLabels = {rafales:"Fortes rafales de vent possibles",petiteGrele:"Gr√™le de petite taille possible",grelleMoyenne:"Gr√™le de taille moyenne possible",grelleGrosse:"Gr√™le de grosse taille possible",fortesPrecip:"Fortes pr√©cipitations possibles",activiteElec:"Orage avec forte activit√© √©lectrique possible",ruissements:"Risque de ruissellements possibles"};
const circleColors = {1:"#2ecc71",2:"#f1c40f",3:"#e67e22",4:"#e74c3c",5:"#9b59b6"};

const markers={}, circles={}, blinkTimers={};
let currentUserUid=null;
const clientInfoDiv = document.getElementById("clientInfo");

// üîπ Login
loginBtn.onclick = ()=>{
  const email = loginEmail.value.trim();
  const pass = loginPassword.value.trim();
  if(!email || !pass) return alert("Veuillez remplir email et mot de passe");

  auth.signInWithEmailAndPassword(email, pass)
    .then(userCred=>{
      currentUserUid = userCred.user.uid;
      document.getElementById("loginOverlay").style.display="none";
      loadPoints();
      showClientInfo();
    })
    .catch(err=>{ alert("Erreur login: "+err.message); });
};

function showClientInfo(){
  if(!currentUserUid) return;
  db.collection("points").where("userId","==",currentUserUid)
    .onSnapshot(snapshot=>{
      if(snapshot.empty){
        clientInfoDiv.textContent = "Aucune information disponible";
        return;
      }
      // On prend le premier point
      const point = snapshot.docs[0].data();
      const email = auth.currentUser?.email || "-";
      const typeSurveillance = point.phenomenonType || "-";
      clientInfoDiv.textContent = `Email: ${email} | Type de surveillance: ${typeSurveillance}`;

      // üîπ AJOUT : lancer l'animation ripple sur le point du client
      animateClientPoint([point.lat, point.lng]);
    });
}


// üîπ Charger points
function loadPoints(){
  db.collection("points").onSnapshot(snapshot=>{
    snapshot.forEach(doc=>{
      const d = doc.data();
      const id = doc.id;
      const level = Math.min(Number(d.alertLevel),5);

      const phenList = d.phenomena
        ? Object.entries(d.phenomena).filter(([k,v])=>v).map(([k])=>phenLabels[k]).join("<br>") || "-"
        : "-";

      const popupHTML = (d.userId===currentUserUid)
        ? `<div class="popup-box">
             <div class="popup-title">${d.name}</div>
             <div class="popup-location">${d.location}</div>
             <div style="text-align:center;">
               <span class="vigi-badge vigi-${level}">${vigilanceText[level]}</span>
             </div>
             <div class="popup-section"><div class="popup-label">Surveillance :</div>${d.phenomenonType || "-"}</div>
             <div class="popup-section"><div class="popup-label">Ph√©nom√®nes associ√©s :</div>${phenList}</div>
             <div class="popup-section"><div class="popup-label">√©volution proch. heures :</div>${d.description || "-"}</div>
             <div class="popup-section"><div class="popup-label">Mise √† jour :</div>${d.updatedAt?.toDate ? d.updatedAt.toDate().toLocaleString() : "-"}</div>
           </div>`
        : `<div class="popup-box" style="text-align:center;font-weight:bold;color:red;">Impossible de voir les informations de cet utilisateur</div>`;

      if(!markers[id]){
        markers[id]=L.marker([d.lat,d.lng],{icon:icons[level]}).addTo(map).bindPopup(popupHTML);
        circles[id]=L.circle([d.lat,d.lng],{radius:1300,color:circleColors[level],fillColor:circleColors[level],fillOpacity:0.15}).addTo(map);
      } else {
        markers[id].setIcon(icons[level]).setPopupContent(popupHTML);
        circles[id].setStyle({color:circleColors[level],fillColor:circleColors[level]});
      }

      if(level>=3 && !blinkTimers[id]){
        let v=true;
        blinkTimers[id]=setInterval(()=>{ if(markers[id]._icon){markers[id]._icon.style.opacity=v?"0.35":"1"; v=!v;} },600);
      }
      if(level<3 && blinkTimers[id]){
        clearInterval(blinkTimers[id]);
        delete blinkTimers[id];
        if(markers[id]._icon) markers[id]._icon.style.opacity="1";
      }
    });
  });
}

// üîπ Fonction pour animer le point du client connect√© (ripple)
function animateClientPoint(clientLatLng) {
  const minRadius = 400;   // rayon minimum du ripple
  const maxRadius = 1500;   // rayon maximum = 3x le point
  let radius = minRadius;
  let growing = true;

  // Cercle attach√© au point du client
  const ripple = L.circle(clientLatLng, {
    color: "#3498db",
    fillColor: "#3498db",
    fillOpacity: 0.3,
    radius: radius
  }).addTo(map);

  // Animation ripple
  const interval = 30; // vitesse de l'animation (ms)
  const step = 25;     // incr√©ment du rayon par frame

  const timer = setInterval(() => {
    // Ajuster le rayon
    if (growing) {
      radius += step;
      if (radius >= maxRadius) growing = false;
    } else {
      radius -= step;
      if (radius <= minRadius) growing = true;
    }

    ripple.setRadius(radius);
    ripple.setLatLng(clientLatLng); // üîπ force le cercle √† rester centr√©
  }, interval);

  // Optionnel : recentrer la carte sur le point au d√©part
  map.setView(clientLatLng, map.getZoom());
}


</script>

</body>
</html>
